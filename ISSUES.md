# `test_map_leaflet.html` の学習課題リスト

このドキュメントは、`test_map_leaflet.html` を教材としてJavaScriptを学ぶ初学者が、次のステップに進むための改修課題をまとめたものです。サンプルコードは意図的にシンプルな作りにしていますが、実用的なアプリケーションを開発するには、ここからさらにいくつかの概念を学ぶ必要があります。

---

## 課題1：検索する地名を固定から動的にする

### 現状

現在、地図に表示する場所（「フィリピン」「大坂」）は、JavaScriptコードの中に直接書き込まれています（ハードコーディング）。

```javascript
// ...
createMap("map1", startPoint, "フィリピン");
createMap("map2", startPoint, "大坂");
```

### 問題点

これでは、別の場所を検索したいと思うたびに、コードを直接書き換える必要があります。ユーザーが自由に入力した地名を地図に表示させることができません。

### チャレンジ

1.  HTMLに、地名を入力するためのテキストボックスと、検索を実行するためのボタンを追加してみましょう。
2.  JavaScriptを修正し、ボタンがクリックされたときにテキストボックスに入力された地名を取得し、その場所を地図に表示するように変更してみましょう。これにより、インタラクティブな地図アプリケーションの第一歩を踏み出すことができます。

---

## 課題2：グローバル変数を減らし、コードを整理する

### 現状

`setCardHeader`, `geocode`, `createMap` といった関数や `startPoint` という変数は、すべてグローバルスコープ（どこからでもアクセスできる場所）に定義されています。

### 問題点

小規模なスクリプトでは問題になりにくいですが、コードが大規模になると、意図せず同じ名前の変数や関数を再定義してしまい、バグの原因となることがあります（名前の衝突）。

### チャレンジ

JavaScriptの `(function() { ... })();` という構文（IIFE: 即時実行関数式）を使って、すべてのコードを囲んでみましょう。これにより、スクリプト内の変数や関数が外部に漏れ出すのを防ぎ、より安全なコード構造を学ぶことができます。

**ヒント:** `ALTJS.md` の「変数のスコープ」のセクションも参考にしてください。

---

## 課題3：エラーハンドリングを実装する

### 現状

`geocode` 関数は、Nominatim APIから地名が見つからなかったケース（`data` が空）は考慮していますが、ネットワーク接続が失敗した場合や、サーバーがエラーを返した場合については何も処理をしていません。

```javascript
// ...
const res = await fetch(url, { headers: { "Accept-Language": "ja" } });
const data = await res.json();
// もし fetch が失敗したら、このスクリプトはエラーで停止してしまう
// ...
```

### 問題点

`fetch` が失敗すると、ブラウザのコンソールにエラーが表示され、スクリプトの実行がそこで止まってしまいます。ユーザーから見れば、何も起こらずにアプリケーションが反応しなくなったように見えます。

### チャレンジ

`try...catch` 構文を使って、`fetch` や `res.json()` が失敗した場合のエラーを捕捉（キャッチ）してみましょう。エラーが発生した際には、`console.error` でエラー内容をコンソールに表示したり、ユーザーに「検索に失敗しました」というメッセージを画面に表示したりする処理を追加することで、堅牢なアプリケーションの作り方を学びます。

**ヒント:** `ALTJS.md` の `.then()` を使った書き方の中にある `.catch()` の部分も参考になります。`async/await` と `try...catch` はセットで使われることが多いです。

---

## 課題4：APIの利用規約を意識する

### 現状

Nominatim APIを直接呼び出していますが、その利用規約についてはコード内に何も記述がありません。

### 問題点

多くの無料APIには、短時間に大量のリクエストを送ることを禁止したり、アプリケーションの識別のために特定のヘッダー（User-Agent）を要求したりするなどの利用規約があります。規約を守らないと、アクセスをブロックされる可能性があります。

### チャレンジ

[Nominatim APIの利用規約](https://operations.osmfoundation.org/policies/nominatim/)を読んでみましょう（英語ですが、翻訳ツールを使っても構いません）。特に "Usage Policy" のセクションに目を通し、どのような要件があるかを確認してください。そして、`fetch` のオプションに、自分のアプリケーション名や連絡先を入れたカスタム `User-Agent` ヘッダーを追加する方法を調べて実装してみましょう。これは、責任ある開発者になるための重要なステップです。

---

## 課題5：DOM操作をより堅牢にする

### 現状

`setCardHeader` 関数は、`mapEl.previousElementSibling` という形で、地図要素の「一つ前の要素」をヘッダー要素として決め打ちで取得しています。

### 問題点

もしHTMLの構造が変わり、地図要素の直前に別の要素（例えば `<br>` タグなど）が追加されると、このコードは正しく動作しなくなります。このように、HTMLの構造に強く依存したセレクタは、予期せぬ変更に弱い（脆弱な）という性質があります。

### チャレンジ

`ALTJS.md` の「代替案：より具体的なIDを直接指定する」で提案されているように、ヘッダー要素にも `id` を付け、`document.getElementById` で直接その要素を取得するように `setCardHeader` 関数を書き換えてみましょう。これにより、HTML構造の変更に強い、より安定したコードを書く練習ができます。

---

## 課題6：「マジックナンバー」をなくす

### 現状

コードの中には、`zoom: 7` や `padding: [50, 50]` のように、その数値が何を意味するのかが直感的に分かりにくい「マジックナンバー」がいくつか存在します。

### 問題点

これらの数値の意味を理解するには、コードの文脈やLeafletライブラリの知識が必要になります。後からコードを読んだり、他の人が修正したりする際に、この数値が何のためのものなのか分からず、修正が困難になることがあります。

### チャレンジ

これらの数値を、意味の分かる名前が付いた定数（`const` 変数）として定義し、元の数値をその定数に置き換えてみましょう。

```javascript
// 例
const INITIAL_ZOOM_LEVEL = 7;
const MAP_PADDING = [50, 50];

// ...
const map = L.map(containerId, ...).setView(startPoint.center, INITIAL_ZOOM_LEVEL);
// ...
map.fitBounds(bounds, { padding: MAP_PADDING });
```

このようにリファクタリングすることで、コードの可読性（読みやすさ）とメンテナンス性を向上させる方法を学びます。
